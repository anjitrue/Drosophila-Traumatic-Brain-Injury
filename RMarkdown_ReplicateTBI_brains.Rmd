---
title: "Drosophila Traumatic Brain Injury Replicate Experiment"
author: "Anji Trujillo - Professor Coon"
date: "September 12, 2019"
output: html_document
---

```{r setup, include=FALSE}
require(knitr)
opts_knit$set(root.dir = "G:/Projects/Proteomics/DorsophilaHead_Experiment/")
knitr::opts_chunk$set(root.dir = "G:/Projects/Proteomics/DorsophilaHead_Experiment/", warning = FALSE, message = FALSE)
```

This is an R Markdown Document describing the proteomics data collected for the Drosophila Traumatic Brain Injury Project in collaboration with Professor Wassarman and Becky Steinbrech. The samples analyzed were derived from heads  of Drosophilla melanogaster that were fed either Food and Water or ONLY Water. There are  time points with a control and a traumatic brain injury (TBI) sample at each time point for the first 24 hours. 

Proteomics data was collected August 11, 2019 and searched on September 1, 2019. The initial analysis was performed September 9, 2019.



The head hemolymph data was searched either as  

* Drosophila (TBI + Control) on Food and Water  
* Drosophila (TBI + Control) on Water only  
* Drosophila (TBI + Control) on Food and Water AND Water only  
 

```{r install_packages, echo=FALSE}
library(readr)
library(plyr)
library(dplyr)
library(pheatmap)
library(pcaMethods)
library(ggplot2)
library(devtools)
library(e1071)
library(dplyr)
library(Mfuzz)
library(cluster)
library(yaml)
library(Rcpp)
```

The data analysis was performed using R. The following functions were written to manipulate the data. Before loading data I manually removed contaminants, reverse sequences, and only identified by site. The dataframe will be subset to utilize Uniprot protein ID's, number identifier provided by MaxQuant, and Gene Name for each protein group.


A following of functions have been written to 

* Remove protein groups that contain less than 50% of measurements across samples  
* Subset LFQ values to protein groups that contain complete measurements across all samples  
* Plotting Standard Deviation of Proteins

```{r functions, echo=FALSE}

subsetLFQ <- function(q){
  y <- q[,c("Protein.IDs", "id","Gene.names")] 
  z <- q[,grep("LFQ.intensity",names(q))]
  z[z == 0] <- NA
  x <- bind_cols(y,z)
  #how many missing values in protein groups dataframe
  print(paste("Number of missing measurements", sum(is.na(x)), " out of ", ncol(x)*nrow(x) , " equates to ", (sum(is.na(x))/(ncol(x)*nrow(x))*100) , "% of data missing from complete data set"))
  x <- x[complete.cases(x),]
  return(x)
 } 
 
remove.features.50percentcuttoff <- function (x) {
  features.missing = rowMeans(is.na(x)) 
  print(paste0("Number of protein groups that have over 50% missing measurements: ",sum(features.missing > 0.50))) 
  features.missing.50more = rownames(x)[features.missing > 0.50] 
  
  keep.features = which(features.missing <= 0.50) 
  print(paste0("Protein groups that pass the 50% filteration: ", length(keep.features)))
  names(keep.features) = keep.features 
  
  remove.features = which(features.missing > 0.50)
  print(paste0("Number of protein groups removed from dataset: ", length(remove.features)))
  names(remove.features) = remove.features
  
  filtered = x[-which(rownames(x) %in% remove.features),]
  return(filtered)
}

filter.std.plotting <- function (eset, min.std,visu=TRUE)
{
  #index <- logical(dim(exprs(eset))[1])

  tmp <- logical(dim(exprs(eset))[1])
  if (is.numeric(min.std))
  { 
    data <- exprs(eset)
      for (i in 1:length(tmp))
      {
        tmp[i]   <- sd(data[i,],na.rm=TRUE)
        #index[i]  <- ( tmp[i] > min.std)
        
      }
    index <- tmp > min.std
    index[is.na(index)] <- TRUE
    cat(paste(sum(!index),"Proteins have a standard deviation greater than ", min.std, ".\n"))
  }
  
  if (visu)
  {
    plot(sort(tmp),xlab="Ordered Hemo Proteins",ylab="Standard Deviation")
  }
  eset[index,]
}

# fuzzyprep_imputation_included <- function(z)
# {
#   exprValues <- new("ExpressionSet", exprs = as.matrix(z))
#   # exclude proteins that have more than 50% of measurements missing
#   exprValues.r <- filter.NA(exprValues, thres = 0.50)
#   # Fuzzy c-means does not allow for missing values, replace missing values by median values
#   exprValues.f = fill.NA(exprValues.r, mode="median")
#   # Set a minimum threshold for variation 
#   tmp = filter.std(exprValues.f, min.std = 0.1)
#   # Clustering is performed in Eculidian space, standaridize abundance values to have a mean value of zero
#   # Ensures that proteins with similar changes in abundance are close in Euclidean space
#   exprValues.s = standardise(tmp)
#   return(exprValues.s)
# }
# 
# fuzzyprep_usepreviousImputation <- function(z)
# {
#   exprValues <- new("ExpressionSet", exprs = as.matrix(z))
#   tmp = filter.std.plotting(exprValues, min.std = 0.1)
#   exprValues.s = standardise(exprValues)
#   return(exprValues.s)
# }
# 
# fuzzyprep_usepreviousImputation_foldchange <- function(z)
# {
#   exprValues <- new("ExpressionSet", exprs = as.matrix(z))
#   tmp = filter.std.plotting(exprValues, min.std = 0.1)
#   #exprValues.s = standardise(exprValues)
#   return(exprValues)
# }

```

#### Load data Drosophila (TBI + Control) on Food and Water AND Water only 
```{r load_data, echo=FALSE}
# Load data containing a subset of columns for the FWW dataset
proteinGroups_dros_Brain_FWW <- read.csv("G:/Projects/Proteomics/DorsophilaHead_Experiment/txt_Food_Water_Water_Together/proteinGroups_Food_Water_Water_Together.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

# Load data containing more information on the scans and quality of identifications
proteinGroups_dros_Brain_FWW_extended <- read.csv("G:/Projects/Proteomics/DorsophilaHead_Experiment/txt_Food_Water_Water_Together/proteinGroups_Food_Water_Water_Together_20191018.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

cat(paste0("Number of protein groups in Brain Data before any filtering of missing measurements: ", nrow(proteinGroups_dros_Brain_FWW)))

# cat(paste0("Number of protein groups in Brain Data before any filtering of missing measurements: ", nrow(proteinGroups_dros_Brain_FWW_extended)))

proteinGroups_dros_Brain_FWW <- subsetLFQ(proteinGroups_dros_Brain_FWW) 
print(paste("Number of complete proteins: ", nrow(proteinGroups_dros_Brain_FWW))) 

```


#### Load data Human Controls used to monitor instrument performance during analysis
```{r subset_HC, echo=FALSE}
hc_Dros_brains <- read.csv("G:/Projects/Proteomics/DorsophilaHead_Experiment/Drosophila_HC/txt/proteinGroups.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

hc_Dros_brains <- subsetLFQ(hc_Dros_brains)
print(paste("Number of complete proteins: ", nrow(hc_Dros_brains))) 

hc <- hc_Dros_brains[,-c(1:3)]
rownames(hc) <- hc_Dros_brains$id
samples_hc <- sub(".*intensity.", "", colnames(hc))
colnames(hc) <- samples_hc

hc$Average <- rowMeans(hc)
hc$Stdev <- apply(hc,1,sd)
hc$CV <- hc$Stdev/hc$Average*100

hc_log2 <- log2(as.matrix(hc_Dros_brains[,grep("LFQ.intensity",names(hc_Dros_brains))[1]:ncol(hc_Dros_brains)]))
rownames(hc_log2) <- hc_Dros_brains$id
colnames(hc_log2) <- samples_hc

pca_complete_HC <- prcomp(t(hc_log2))

t_hc <- t(hc_log2)

```


